## 1. 前提：無料プランの制約

Emotivの**無料プラン**では生のEEG波形（RAW）は取得できず、代わりに以下が使えます：

* **Band Power（POW）**：各電極ごとの θ（4–8Hz）, α（8–12Hz）, β（12–30Hzを低域/高域に分割）, γ（>30Hz）の平均パワー
* **Motion（MOT）**：加速度・ジャイロ（体動や安静度の推定に利用できる）
* **Device info（DEV）**：信号品質（全体の接触状態など）
* **Facial Expression（FAC）**：まばたきや眼球運動（左右）、笑顔など
* （拡張）外部デバイスから**EOG**を受け取って同期させれば、REMの検出に大きく貢献

つまり、AASMが定義する正式なステージ判定（N1, N2, N3, REM, Wake）に必要な
**睡眠紡錘（spindle）、徐波（slow waves）、筋緊張の低下**は直接見られません。
したがって本手法では「候補」レベルの推定を行います。

---

## 2. 解析の流れ

### (1) データ収集とウィンドウ化

* すべてのデータを\*\*30秒間の窓（epoch）\*\*にまとめ、数秒ごとに更新。
  → 睡眠研究の標準単位に合わせたもの。

### (2) 特徴量抽出

窓ごとに以下の特徴量を計算します：

* **θ/α比**

  * θ波（4–8Hz）/ α波（8–12Hz）の比率。
  * 入眠や浅い睡眠（N1〜N2）ではαが減りθが優位になるため、比率が上昇すれば「睡眠っぽい」指標。

* **βの相対量**

  * β波（覚醒・認知活動と関連）が全体に占める割合。
  * 覚醒やREMでは相対的にβが高めになる。
  * 深いNREM（N3）ではβが低下する。

* **体動（Motion RMS）**

  * 加速度の大きさを要約し、「安静か／動いているか」を判定。
  * 入眠すると体動は減少する。Actigraphy的な「Wake/Sleep」判別に有効。

* **眼球運動（Facial Expressions または外部EOG）**

  * 左右眼球運動やまばたき率を検出。
  * REM睡眠では急速眼球運動が増えるため、その出現率をREM候補の根拠に。
  * 外部EOGがあればさらに精度が高い。

* **信号品質（Device Signal）**

  * センサー接触が悪いときは解析自体を無効にして「欠測」とする。

---

## 3. ステージ候補の判定ロジック

特徴量から**簡易ルールベース**で候補を推定します。

* **Wake**

  * θ/α比が低い（= αが優位、θが少ない）
  * 体動が多い
    → 「起きている」可能性が高い

* **Light NREM（N1〜N2候補）**

  * θ/α比が高い（= θが優位）
  * 体動が減って安静状態
    → 浅い睡眠の候補

* **REM候補**

  * 体動が少ない
  * βの相対量が高め
  * 眼球運動（FAC/EOG）イベントが一定以上検出される
    → 「夢を見ている睡眠」の候補

* **Deep NREM（N3候補）**

  * 体動が少ない
  * βの相対量が非常に低い
  * （本来はδ波が必要だが、代わりに「長時間安静＋低β」で代替）
    → 「深い睡眠」の候補

---

## 4. スムージングと遷移制約

* 睡眠ステージは**短時間でコロコロ変化することは生理的にない**ので、以下の工夫を入れます：

  * **最短滞在時間**：いったんステージ候補が決まると、20秒程度は維持し、急な変化を防ぐ。
  * **非現実的遷移の抑制**：WakeからいきなりREMには移行させない（必ずLight NREMを経由するように）。
  * **Deep候補の慎重さ**：Deepは滅多に出ないので、より長い安静や低βを必要条件にする。

これにより「人間の睡眠らしい」連続性を持たせます。

---

## 5. 出力

* 各30秒窓について

  * **候補ステージ（Wake, Light\_NREM\_candidate, REM\_candidate, Deep\_candidate）**
  * **信頼度（Confidence）**
  * 各特徴量の値（θ/α比、β比、体動量、眼球運動率、信号品質）
    を記録。

→ これを時系列で並べれば**簡易ヒプノグラム**が得られます。

---

## まとめ

* **原理**：θ/α比や体動で睡眠と覚醒を区別し、眼球運動やβ活動でREM候補を補強、低β＋安静で深睡眠候補を推定。
* **限界**：RAW EEGがないため、正式なN2/N3の判定（紡錘・徐波）はできない。EOGやEMGがないとREMの確証も弱い。
* **工夫**：ルールベース＋スムージングで、生理的に妥当な候補推定を実現。

---

👉 この仕組みを踏まえれば「無料API＋外部EOG」で**睡眠ステージの大まかな流れを追う**ことは可能です。ただし学術的には「候補ラベル」として扱う必要があります。

---

| ステージ         | AASM基準の必須指標                                             | 本来必要な信号             | 無料APIでの代替指標                                                      | 判定の限界・注意点                                              |
| ------------ | ------------------------------------------------------- | ------------------- | ---------------------------------------------------------------- | ------------------------------------------------------ |
| **Wake**     | - α波（8–12Hz）優位（特に後頭部）<br>- 体動やまばたきの存在                   | EEG (RAW), EOG, EMG | - αパワー高 / θ低（powストリーム θ/α比で代替）<br>- MOTストリームで体動の多さ<br>- FACでまばたき | 比較的信頼度高い。EOGなしでも可能。                                    |
| **N1** （入眠期） | - α減少、θ波増加<br>- 低振幅混合周波                                 | EEG (RAW)           | - θ/α比の上昇（powストリーム）<br>- MOTで体動減少                                | N2との区別が難しい。正式にはK複合波/紡錘が必要。                             |
| **N2** （浅睡眠） | - 睡眠紡錘（12–14Hz）<br>- K複合波（大きな陰性波＋陽性波）                   | EEG (RAW)           | - **直接代替なし**<br>- 長時間の安静＋θ優位で近似                                  | 紡錘・K複合が見えないため、**N1とN2を区別できず**「Light NREM候補」とまとめるのが現実的。 |
| **N3** （深睡眠） | - 徐波（0.5–2Hz, 振幅 ≥75µV, 出現率20%以上）                       | EEG (RAW, δ帯)       | - **δ帯はpowストリームに含まれない**ため直接不可<br>- 代わりに「βの相対低下＋長時間安静」で近似         | N3確定は不可。「Deep candidate」として擬似判定。                       |
| **REM**      | - 覚醒様EEG（低振幅・混合周波）<br>- 急速眼球運動 (EOG)<br>- 筋トーヌス低下 (EMG) | EEG, EOG, EMG       | - β比上昇（powストリーム）<br>- FACで眼球左右運動<br>- MOTで体動が少ない                 | 外部EOGがあるとREM候補の精度↑。筋緊張低下（EMG）が取れないため確証は弱い。             |


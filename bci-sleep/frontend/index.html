<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Sleep Candidates Dashboard</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
  <style>
    :root { --bg:#0f172a; --fg:#e2e8f0; --muted:#94a3b8; --card:#111827; --accent:#38bdf8; }
    body { margin:0; background:var(--bg); color:var(--fg); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto;}
    .wrap { max-width:1100px; margin:32px auto; padding:0 16px;}
    .row { display:grid; gap:16px; grid-template-columns: 1fr; }
    @media(min-width:900px){ .row{ grid-template-columns: 2fr 1fr; } }
    .card { background:var(--card); border-radius:16px; padding:16px; box-shadow: 0 10px 30px rgba(0,0,0,.25);}
    .title { font-size:18px; margin:4px 0 12px; color:#fff;}
    .badges { display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .badge { font-size:12px; padding:6px 10px; border-radius:999px; background:#1f2937; color:#cbd5e1; }
    .badge.ok{ background:#064e3b; color:#86efac;}
    .badge.warn{ background:#3f1d2e; color:#fda4af;}
    .badge.user{ background:#1e40af; color:#93c5fd;}
    .badge.info{ background:#1e293b; color:#94a3b8;}
    .badge.session{ background:#7c3aed; color:#c4b5fd;}
    .kpi { display:grid; grid-template-columns: repeat(4,1fr); gap:10px; margin-top:8px;}
    .kpi .card { padding:12px; text-align:center;}
    .kpi .num { font-size:20px; font-weight:700;}
    .kpi .lbl { font-size:12px; color:var(--muted);}
    canvas { width:100% !important; height:360px !important;}
    footer{ margin-top:24px; color:var(--muted); font-size:12px;}
    a{ color: var(--accent); text-decoration: none; }
    .user-list { margin-bottom: 16px; }
    .user-list h3 { margin-bottom: 8px; }
    .user-links { display: flex; gap: 8px; flex-wrap: wrap; }
    .user-link { 
      display: inline-block; 
      padding: 6px 12px; 
      background: var(--card); 
      border-radius: 8px; 
      border: 1px solid var(--muted);
      transition: all 0.2s;
    }
    .user-link:hover { 
      background: var(--accent); 
      color: var(--bg); 
      border-color: var(--accent);
    }
    .user-link.has-data {
      border-color: var(--accent);
      background: rgba(56, 189, 248, 0.1);
    }
    .user-details {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }
    .add-user-form { 
      margin-top: 12px; 
      display: flex; 
      gap: 8px; 
      align-items: center;
    }
    .add-user-form input { 
      padding: 6px 12px; 
      background: var(--card); 
      border: 1px solid var(--muted); 
      border-radius: 6px; 
      color: var(--fg);
    }
    .add-user-form button { 
      padding: 6px 12px; 
      background: var(--accent); 
      color: var(--bg); 
      border: none; 
      border-radius: 6px; 
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Sleep Candidates Dashboard</h1>
    
    <!-- ユーザーリストセクション -->
    <div class="card user-list">
      <h3>登録済みユーザー</h3>
      <div id="userLinks" class="user-links">
        <span>読み込み中...</span>
      </div>
      <div class="add-user-form">
        <input type="text" id="newUsername" placeholder="新しいユーザー名" maxlength="50">
        <button onclick="addNewUser()">追加</button>
      </div>
    </div>
    
    <div class="badges">
      <span id="csvBadge" class="badge">CSV: —</span>
      <span id="eogBadge" class="badge">EOG: —</span>
      <span id="sigBadge" class="badge">Signal: —</span>
      <span id="statusBadge" class="badge">Status: 初期化中</span>
    </div>

    <div class="row" style="margin-top:16px;">
      <div class="card">
        <div class="title">Hypnogram-like Timeline</div>
        <div id="noDataMessage" style="display:none; text-align:center; padding:40px; color:var(--muted);">
          <h3>データがありません</h3>
          <p>デバイスと接続してデータ収集を開始してください</p>
          <p>または、各メンバーのダッシュボードにアクセスしてください</p>
        </div>
        <canvas id="chartHypno"></canvas>
      </div>
      <div class="card">
        <div class="title">Latest KPIs</div>
        <div class="kpi">
          <div class="card"><div class="num" id="kStage">—</div><div class="lbl">Stage</div></div>
          <div class="card"><div class="num" id="kConf">—</div><div class="lbl">Confidence</div></div>
          <div class="card"><div class="num" id="kThetaAlpha">—</div><div class="lbl">θ/α</div></div>
          <div class="card"><div class="num" id="kBeta">—</div><div class="lbl">β (rel)</div></div>
        </div>
        <div class="kpi" style="margin-top:8px;">
          <div class="card"><div class="num" id="kMotion">—</div><div class="lbl">Motion RMS</div></div>
          <div class="card"><div class="num" id="kEOG">—</div><div class="lbl">EOG sacc/s</div></div>
          <div class="card"><div class="num" id="kFac">—</div><div class="lbl">FAC rate</div></div>
          <div class="card"><div class="num" id="kSignal">—</div><div class="lbl">Signal</div></div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:16px;">
      <div class="card">
        <div class="title">Brain Waves (θ/α & β)</div>
        <canvas id="chartBrainWaves"></canvas>
      </div>
      <div class="card">
        <div class="title">Motion & EOG</div>
        <canvas id="chartMotion"></canvas>
      </div>
    </div>

    <footer>
      <p>表示は 30s 窓・5s 更新の <em>候補ステージ</em>（Wake / Light / REM / Deep）。AASM正式判定ではありません。</p>
      <p>全体ダッシュボード - 各ユーザーのレイヤーにアクセスするには上記のユーザーリンクを使用してください。</p>
    </footer>
  </div>

  <script>
    // ユーザー管理機能
    async function loadUsers() {
      try {
        const response = await fetch('/api/users');
        const data = await response.json();
        const userLinks = document.getElementById('userLinks');
        
        if (data.users && data.users.length > 0) {
          userLinks.innerHTML = data.users.map(user => {
            const hasDataClass = user.has_data ? 'has-data' : '';
            const sessionInfo = user.total_sessions > 0 ? 
              `<span class="badge session">${user.total_sessions}セッション</span>` : '';
            
            return `
              <div class="user-link ${hasDataClass}">
                <a href="/${user.username}">${user.display_name}</a>
                <div class="user-details">
                  ${user.notes}<br>
                  ${sessionInfo}
                </div>
              </div>
            `;
          }).join('');
        } else {
          userLinks.innerHTML = '<span>ユーザーが登録されていません</span>';
        }
      } catch (error) {
        console.error('ユーザーリストの読み込みに失敗:', error);
        document.getElementById('userLinks').innerHTML = '<span>エラー: ユーザーリストを読み込めません</span>';
      }
    }

    function addNewUser() {
      const input = document.getElementById('newUsername');
      const username = input.value.trim();
      
      if (!username) {
        alert('ユーザー名を入力してください');
        return;
      }
      
      if (!/^[a-zA-Z0-9_-]+$/.test(username)) {
        alert('ユーザー名は英数字、アンダースコア、ハイフンのみ使用できます');
        return;
      }
      
      // 新しいユーザーページにリダイレクト
      window.location.href = `/${username}`;
    }

    // Enterキーでユーザー追加
    document.getElementById('newUsername').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        addNewUser();
      }
    });

    // ページ読み込み時にユーザーリストを更新
    window.addEventListener('load', loadUsers);
  </script>

  <script src="/app.js"></script>
</body>
</html>

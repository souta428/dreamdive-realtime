<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMOTIV Sleep Staging - リアルタイム睡眠解析</title>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        .stage-wake { color: #ff6b6b; }
        .stage-light { color: #4ecdc4; }
        .stage-deep { color: #45b7d1; }
        .stage-rem { color: #96ceb4; }
        
        .charts {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .chart-container h3 {
            margin-top: 0;
            text-align: center;
            color: #333;
        }
        .status {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧠 EMOTIV Sleep Staging</h1>
            <p>リアルタイム睡眠段階解析システム</p>
        </div>

        <div id="status" class="status disconnected">
            接続待機中...
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3>現在のステージ</h3>
                <div id="current-stage" class="stat-value">-</div>
                <div id="current-time">--:--:--</div>
            </div>
            <div class="stat-card">
                <h3>Alpha波</h3>
                <div id="alpha-value" class="stat-value">-</div>
                <small>相対パワー</small>
            </div>
            <div class="stat-card">
                <h3>Theta波</h3>
                <div id="theta-value" class="stat-value">-</div>
                <small>相対パワー</small>
            </div>
            <div class="stat-card">
                <h3>Beta波</h3>
                <div id="beta-value" class="stat-value">-</div>
                <small>相対パワー</small>
            </div>
            <div class="stat-card">
                <h3>運動量</h3>
                <div id="move-value" class="stat-value">-</div>
                <small>RMS</small>
            </div>
        </div>

        <div class="charts">
            <div class="chart-container">
                <h3>睡眠段階推移 (Hypnogram)</h3>
                <canvas id="hypnogram-chart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>脳波帯域比</h3>
                <canvas id="bands-chart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>運動量</h3>
                <canvas id="movement-chart"></canvas>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        
        // データ保存用配列
        let timeLabels = [];
        let stageData = [];
        let alphaData = [];
        let thetaData = [];
        let betaData = [];
        let moveData = [];
        
        const maxDataPoints = 100; // 表示する最大データ点数
        
        // ステージ名とインデックスのマッピング
        const stageMapping = {
            'Wake': 3,
            'NREM_Light': 2, 
            'NREM_Deep': 1,
            'REM_like': 0
        };
        
        const stageColors = {
            'Wake': '#ff6b6b',
            'NREM_Light': '#4ecdc4',
            'NREM_Deep': '#45b7d1', 
            'REM_like': '#96ceb4'
        };

        // Chart.js設定
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: '時間'
                    }
                },
                y: {
                    display: true
                }
            },
            plugins: {
                legend: {
                    display: true
                }
            },
            animation: false
        };

        // Hypnogram Chart
        const hypnogramCtx = document.getElementById('hypnogram-chart').getContext('2d');
        const hypnogramChart = new Chart(hypnogramCtx, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: '睡眠段階',
                    data: stageData,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    stepped: true,
                    fill: true
                }]
            },
            options: {
                ...commonOptions,
                scales: {
                    ...commonOptions.scales,
                    y: {
                        ...commonOptions.scales.y,
                        min: -0.5,
                        max: 3.5,
                        ticks: {
                            stepSize: 1,
                            callback: function(value) {
                                const stages = ['REM_like', 'NREM_Deep', 'NREM_Light', 'Wake'];
                                return stages[value] || '';
                            }
                        },
                        title: {
                            display: true,
                            text: '睡眠段階'
                        }
                    }
                }
            }
        });

        // Bands Chart
        const bandsCtx = document.getElementById('bands-chart').getContext('2d');
        const bandsChart = new Chart(bandsCtx, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [
                    {
                        label: 'Alpha',
                        data: alphaData,
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)'
                    },
                    {
                        label: 'Theta', 
                        data: thetaData,
                        borderColor: '#4ecdc4',
                        backgroundColor: 'rgba(78, 205, 196, 0.1)'
                    },
                    {
                        label: 'Beta',
                        data: betaData,
                        borderColor: '#45b7d1',
                        backgroundColor: 'rgba(69, 183, 209, 0.1)'
                    }
                ]
            },
            options: {
                ...commonOptions,
                scales: {
                    ...commonOptions.scales,
                    y: {
                        ...commonOptions.scales.y,
                        title: {
                            display: true,
                            text: '相対パワー'
                        }
                    }
                }
            }
        });

        // Movement Chart
        const movementCtx = document.getElementById('movement-chart').getContext('2d');
        const movementChart = new Chart(movementCtx, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: '運動量 (RMS)',
                    data: moveData,
                    borderColor: '#96ceb4',
                    backgroundColor: 'rgba(150, 206, 180, 0.1)',
                    fill: true
                }]
            },
            options: {
                ...commonOptions,
                scales: {
                    ...commonOptions.scales,
                    y: {
                        ...commonOptions.scales.y,
                        title: {
                            display: true,
                            text: '運動量 (RMS)'
                        }
                    }
                }
            }
        });

        // Socket.io イベントハンドラ
        socket.on('connect', function() {
            document.getElementById('status').className = 'status connected';
            document.getElementById('status').textContent = '✅ EMOTIV システムに接続済み';
        });

        socket.on('disconnect', function() {
            document.getElementById('status').className = 'status disconnected';
            document.getElementById('status').textContent = '❌ 接続が切断されました';
        });

        socket.on('sleep_data', function(data) {
            // データ配列に追加
            timeLabels.push(data.time_str);
            stageData.push(stageMapping[data.stage]);
            alphaData.push(data.alpha);
            thetaData.push(data.theta);
            betaData.push(data.beta);
            moveData.push(data.moveRMS);

            // 最大データ点数を超えたら古いデータを削除
            if (timeLabels.length > maxDataPoints) {
                timeLabels.shift();
                stageData.shift();
                alphaData.shift();
                thetaData.shift();
                betaData.shift();
                moveData.shift();
            }

            // 統計表示を更新
            document.getElementById('current-stage').textContent = data.stage;
            document.getElementById('current-stage').className = `stat-value stage-${data.stage.toLowerCase().replace('_', '-')}`;
            document.getElementById('current-time').textContent = data.time_str;
            document.getElementById('alpha-value').textContent = data.alpha.toFixed(3);
            document.getElementById('theta-value').textContent = data.theta.toFixed(3);
            document.getElementById('beta-value').textContent = data.beta.toFixed(3);
            document.getElementById('move-value').textContent = data.moveRMS.toFixed(3);

            // チャートを更新
            hypnogramChart.update('none');
            bandsChart.update('none');
            movementChart.update('none');
        });
    </script>
</body>
</html>
